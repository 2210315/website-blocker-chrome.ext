<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Popup | Website Blocker</title>
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/popup.css" />
    <link rel="stylesheet" href="css/form.css" />
    <script src="lib/jquery-1.7.2.min.js"></script>
    <script src="js/common.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/functions.js"></script>
    <script src="js/website-blocker.js"></script>
    <script src="js/controller.js"></script>
</head>
<body>
<div id="container" style="display: none; width: 500px; height: 100%;">

    <header>
        <h1><b i18n="ext_name">Website Blocker</b></h1>
    </header>

    <section class="top-shadow clearfix">
        <article id="block-ng" i18n="block_ng" class="hide">
            This page cannot block.
        </article>
        <article id="block-already" i18n="block_already" class="hide">
            This page is already blocked.
        </article>
        <article id="block-ok" class="hide">

            <div class="group">
                <h3 i18n="add_domain">URL</h3>
                <input type="text" id="tmp-hostname" style="width: 95%;" placeholder="www.facebook.com" />
            </div>

            <div class="group">
                <h3 i18n="add_block_time">--</h3>
                <div class="time-group">
                    <span i18n="add_time_1"></span>
                    <input type="time" id="tmp-time-start" style="width: 4em;" placeholder="00:00" />
                    <span i18n="add_time_2"></span>
                    <input type="time" id="tmp-time-end" style="width: 4em;" placeholder="23:59" />
                    <span i18n="add_time_3"></span>
                </div>
            </div>

            <button id="blockthis" i18n="add_blockthis" class="submit blue">Block this!</button>
        </article>
    </section>

    <footer class="clearfix">
        <nav id="control-nav" class="clearfix">
            <button i18n="tell" class="tell submit">--</button>
            <button i18n="options" class="options submit">--</button>
            <button i18n="please_support_me" class="please_support_me submit">--</button>
            <button i18n="bug_report" class="bug_report submit">--</button>
            <button i18n="close" class="submit" onclick="window.close()">--</button>
        </nav>
        <div class="clearfix">
            <small class="copyright">
                Copyright &copy; <a href="http://tetsuwo.tumblr.com/" target="_blank">Tetsuwo OISHI</a>, All Rights Reserved.
            </small>
        </div>
    </footer>

    <form id="paypal" action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
        <input type="hidden" name="cmd" value="_s-xclick" />
        <input type="hidden" name="hosted_button_id" value="MVTPVJW3QACLW" />
    </form>

</div><!-- /container -->

<script>

    var WB = new WebsiteBlocker();
    var is_bg_executed = false;

    chrome.extension.getBackgroundPage().getUrl(function(tab) {
        is_bg_executed = true;
        $('#popup-body article').hide();
//        console.log(tab);

        if (tab && tab.url) {
//            console.log(WB.checkUrl(null, tab.url.href, true));
            if (WB.checkUrl(null, tab.url.href, true)) {
                $('#block-already').show();
            }
            else {
                $('#tmp-hostname').val(tab.url.hostname).end().focus();
                $('#block-ok').show();
            }
        }
        else {
            $('#block-ng').show();
        }
    });

    setTimeout(function() {
        if (!is_bg_executed) {
            $('#block-ng').show();
        }
    }, 3000);

    $(window).load(function() {
        Controller.popupPage();
        i18n(function(){ $('#container').show(); });
    });

    $('.options').click(function() {
        check2go(chrome.extension.getURL('options.html'), false);
    });

    $('#blockthis').click(function() {
        var domain, time1, time2, times = [];
        domain = $('#tmp-hostname').val();
        time1  = $('#tmp-time-start').val().replace(':', '');
        time2  = $('#tmp-time-end').val().replace(':', '');

        if (time1 && time2) {
            times = [time1 + '-' + time2];
        }

        Controller.addBlockData(domain, times);

        alert('');
    });

    $('[i18n="options"]').css('display', ls.get('option_page_link_disabled') ? 'none' : 'inline-block');
    $('#each_function_controler').css('display', ls.get('popup_page_control_disabled') ? 'none' : 'inline-block');

</script>

</body>
</html>
